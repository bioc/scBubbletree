---
title: "Case study: Exploring PBMCs with scBubbletree"
author: "SK"
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 1
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = F,
                      comment = F, 
                      warning = F, 
                      message = F)
```



```{r, echo = T, results='hide'}
library(scBubbletree)
```



```{r}
A <- get(load(file = "case_study_D/A.RData"))
meta <- get(load(file = "case_study_D/meta.RData"))
markers <- get(load(file = "case_study_D/markers.RData"))
```




```{r, fig.width=4, fig.height=3, echo = T}

b <- scBubbletree::get_k(B = 5,
                         cv_prop = 0.33,
                         ks = seq(from = 1, to = 40, by = 3),
                         x = A,
                         cores = 4,
                         kmeans_algorithm = "MacQueen")

```



```{r}
ggplot(data = b$gap_stats_summary)+
  geom_point(aes(x = k, y = gap_mean), size = 1)+
  geom_errorbar(aes(x = k, y = gap_mean, ymin = L95, ymax = H95), width = 0.1)+
  ylab(label = "Gap")|
ggplot(data = b$wss_stats_summary)+
  geom_point(aes(x = k, y = wss_mean), size = 1)+
  geom_errorbar(aes(x = k, y = wss_mean, ymin = L95, ymax = H95), width = 0.1)+
  ylab(label = "WCSS")+
  scale_y_log10()+
  annotation_logticks(base = 10, sides = "l")
```








## Lets try `k=18`


```{r, echo=T}

k18 <- scBubbletree::get_bubbletree(x = A,
                                    k = 18,
                                    seed = 954,
                                    cores = 4,
                                    B = 100,
                                    N_eff = 100,
                                    round_digits = 1,
                                    show_branch_support = T)

```


```{r, fig.width=9, fig.height=5, fig.align='center', echo=T}
c1 <- meta$celltype.l1
c2 <- gsub(pattern = "Proliferating", replacement = 'prolif.', meta$celltype.l2)
c2 <- gsub(pattern = "CD56bright", replacement = 'CD56', x = c2)
donor <- meta$donor
```


```{r, fig.width=9, fig.height=5, fig.align='center', echo=T}
w2 <- get_cat_feature_tiles(d = k18,
                            a = donor,
                            feature_composition = T,
                            round_digits = 1,
                            show_hclust = F,
                            tile_text_size = 2.75)
```


```{r, fig.width=8, fig.height=5}
k18$tree+w2$w
```


```{r, fig.width=9, fig.height=5, fig.align='center', echo=T}
w0_1 <- get_cat_feature_tiles(d = k18,
                            a = c1, # res = 1
                            feature_composition = T,
                            round_digits = 0,
                            show_hclust = F,
                            tile_text_size = 2.75)


w0_2 <- get_cat_feature_tiles(d = k18,
                            a = c1, 
                            feature_composition = F,
                            round_digits = 0,
                            show_hclust = F,
                            tile_text_size = 2.75)
```


```{r, fig.width=9, fig.height=5, fig.align='center', echo=T}
w1_1 <- get_cat_feature_tiles(d = k18,
                            a = c2,
                            feature_composition = T,
                            round_digits = 0,
                            show_hclust = F,
                            tile_text_size = 2.25)

w1_2 <- get_cat_feature_tiles(d = k18,
                            a = c2,
                            feature_composition = F,
                            round_digits = 0,
                            show_hclust = F,
                            tile_text_size = 2.25)
```



```{r, fig.width=8, fig.height=5}
k18$tree+w0_2$w+patchwork::plot_layout(widths = c(1, 3))
```



```{r, fig.width=8, fig.height=5}
k18$tree+w1_2$w+patchwork::plot_layout(widths = c(1, 3))
```





```{r, echo = F, results='hide', fig.width=7}
# This function build the nummeric annotations plot
a <- data.frame(mt_prop = meta$mt,
                count_RNA = meta$nCount_RNA,
                count_genes = meta$nFeature_RNA)

sup_w <- (get_num_feature_violins(d = k18,
                                 as = data.frame(MT = a$mt_prop),
                                 plot_title = "",
                                 show_cells = F)$w|
            get_num_feature_violins(d = k18,
                                 as = data.frame(count_RNA = a$count_RNA/1000),
                                 plot_title = "",
                                 show_cells = F)$w|
            get_num_feature_violins(d = k18,
                                 as = data.frame(count_genes = a$count_genes),
                                 plot_title = "",
                                 show_cells = F)$w
          )


sup_w
```



## Quantiative features

Gene expression annotations can also be integrated to better explain the 
bubbles and the tree structure. Lets visualize the mean gene expression of some 
marker genes in the bubbles:

  * GNLY, NKG7:	*NK cells*
  * IL7R:	*CD4 T cells*
  * CD8A:	*CD8 T cells*
  * MS4A1:	*B cells*
  * CD14, LYZ:	*CD14+ Monocytes*
  * FCGR3A, MS4A7:	*FCGR3A+ Monocytes*
  * FCER1A, CST3:	*Dendritic Cells*
  * PPBP:	*Megakaryocytes*


```{r, fig.width=6, fig.height=6, fig.align='center', echo=T}
# This function build the nummeric annotations plot
w3 <- get_num_feature_tiles(d = k18,
                            as = markers,
                            plot_title = "",
                            round_digits = 1,
                            tile_text_size = 2.5)

# Plot
(k18$tree|w3$w)+patchwork::plot_layout(widths = c(2, 3))
```


```{r, fig.width=8, fig.height=9, fig.align='center', echo=T}
w4 <- get_num_feature_violins(d = k18,
                              as = markers,
                              plot_title = "",
                              scales = 'free_x',
                              show_cells = F)


((k18$tree|w3$w)+patchwork::plot_layout(widths = c(1, 1)))/w4$w
```



